# BandPro 樂團團譜打譜系統 - 系統分析文件（SA）

## 1. 系統架構設計

### 1.1 總體架構
```
┌─────────────────────────────────────────────────┐
│                前端層 (Vue.js)                   │
├─────────────────────────────────────────────────┤
│                WebSocket 層                     │
├─────────────────────────────────────────────────┤
│                API 閘道層                       │
├─────────────────────────────────────────────────┤
│                業務邏輯層                        │
├─────────────────────────────────────────────────┤
│                資料訪問層                        │
├─────────────────────────────────────────────────┤
│                資料儲存層                        │
└─────────────────────────────────────────────────┘
```

### 1.2 前端模組架構
```
src/
├── components/          # Vue 組件
│   ├── common/         # 通用組件
│   ├── editor/         # 編輯器組件
│   ├── collaboration/  # 協作組件
│   └── export/         # 匯出組件
├── stores/             # Pinia 狀態管理
├── services/           # API 服務
├── utils/              # 工具函數
├── types/              # TypeScript 類型
└── views/              # 頁面視圖
```

## 2. 資料模型設計

### 2.1 樂譜資料結構（JSON Schema）
```json
{
  "score": {
    "id": "string",
    "title": "string",
    "composer": "string",
    "arranger": "string",
    "keySignature": "string",
    "timeSignature": "string",
    "tempo": "number",
    "created": "datetime",
    "modified": "datetime",
    "version": "number",
    "parts": [
      {
        "id": "string",
        "instrument": "string",
        "instrumentFamily": "string",
        "clef": "string",
        "transposition": "number",
        "measures": [
          {
            "id": "string",
            "number": "number",
            "notes": [
              {
                "id": "string",
                "pitch": "string",
                "duration": "string",
                "accidental": "string",
                "dotted": "boolean",
                "tied": "boolean",
                "position": "number"
              }
            ],
            "rests": [
              {
                "id": "string",
                "duration": "string",
                "position": "number"
              }
            ],
            "dynamics": [
              {
                "type": "string",
                "position": "number"
              }
            ],
            "articulations": [
              {
                "type": "string",
                "noteId": "string"
              }
            ]
          }
        ]
      }
    ],
    "metadata": {
      "tags": ["string"],
      "genre": "string",
      "difficulty": "number",
      "duration": "number"
    }
  }
}
```

### 2.2 用戶協作資料結構
```json
{
  "session": {
    "id": "string",
    "scoreId": "string",
    "users": [
      {
        "id": "string",
        "name": "string",
        "role": "string",
        "permissions": ["string"],
        "cursor": {
          "partId": "string",
          "measureId": "string",
          "position": "number"
        },
        "color": "string",
        "online": "boolean"
      }
    ],
    "operations": [
      {
        "id": "string",
        "userId": "string",
        "type": "string",
        "target": "string",
        "data": "object",
        "timestamp": "datetime",
        "applied": "boolean"
      }
    ]
  }
}
```

## 3. 系統組件設計

### 3.1 樂譜編輯器組件
#### 3.1.1 ScoreEditor（樂譜編輯器主組件）
```typescript
interface ScoreEditorProps {
  scoreId: string;
  readonly?: boolean;
  collaborative?: boolean;
}

interface ScoreEditorState {
  score: Score;
  selectedNotes: Note[];
  currentTool: EditorTool;
  zoom: number;
  cursor: EditorCursor;
}
```

#### 3.1.2 StaffRenderer（五線譜渲染器）
```typescript
interface StaffRendererProps {
  measures: Measure[];
  clef: ClefType;
  keySignature: string;
  width: number;
  height: number;
}
```

#### 3.1.3 NoteInput（音符輸入組件）
```typescript
interface NoteInputProps {
  duration: NoteDuration;
  accidental?: Accidental;
  onNoteAdd: (note: Note) => void;
}
```

### 3.2 協作組件
#### 3.2.1 CollaborationPanel（協作面板）
```typescript
interface CollaborationPanelProps {
  users: User[];
  currentUser: User;
  onUserPermissionChange: (userId: string, permissions: Permission[]) => void;
}
```

#### 3.2.2 UserCursor（用戶游標）
```typescript
interface UserCursorProps {
  user: User;
  position: CursorPosition;
  visible: boolean;
}
```

### 3.3 匯出組件
#### 3.3.1 ExportDialog（匯出對話框）
```typescript
interface ExportDialogProps {
  score: Score;
  formats: ExportFormat[];
  onExport: (format: ExportFormat, options: ExportOptions) => void;
}
```

## 4. 狀態管理設計

### 4.1 Pinia Store 結構
#### 4.1.1 ScoreStore（樂譜狀態）
```typescript
export const useScoreStore = defineStore('score', {
  state: () => ({
    currentScore: null as Score | null,
    scores: [] as Score[],
    selectedNotes: [] as Note[],
    currentTool: EditorTool.SELECT,
    zoom: 1.0,
    cursor: null as EditorCursor | null
  }),
  
  actions: {
    async loadScore(scoreId: string),
    async saveScore(score: Score),
    addNote(note: Note),
    deleteNote(noteId: string),
    updateNote(noteId: string, updates: Partial<Note>),
    selectNotes(noteIds: string[]),
    setCurrentTool(tool: EditorTool),
    setZoom(level: number)
  }
});
```

#### 4.1.2 CollaborationStore（協作狀態）
```typescript
export const useCollaborationStore = defineStore('collaboration', {
  state: () => ({
    session: null as CollaborationSession | null,
    users: [] as User[],
    operations: [] as Operation[],
    connected: false
  }),
  
  actions: {
    async joinSession(scoreId: string),
    async leaveSession(),
    applyOperation(operation: Operation),
    sendOperation(operation: Operation),
    updateUserCursor(userId: string, cursor: EditorCursor)
  }
});
```

### 4.2 事件驅動架構
```typescript
// 事件類型定義
interface EditorEvent {
  type: string;
  payload: any;
  timestamp: number;
  userId?: string;
}

// 事件總線
class EventBus {
  private listeners: Map<string, Function[]> = new Map();
  
  on(event: string, callback: Function): void;
  off(event: string, callback: Function): void;
  emit(event: string, payload: any): void;
}
```

## 5. API 設計

### 5.1 RESTful API 端點
```
GET    /api/scores              # 獲取樂譜列表
POST   /api/scores              # 創建新樂譜
GET    /api/scores/:id          # 獲取特定樂譜
PUT    /api/scores/:id          # 更新樂譜
DELETE /api/scores/:id          # 刪除樂譜

GET    /api/scores/:id/parts    # 獲取樂譜聲部
POST   /api/scores/:id/parts    # 添加聲部
PUT    /api/scores/:id/parts/:partId  # 更新聲部

POST   /api/scores/:id/export   # 匯出樂譜
POST   /api/scores/import       # 匯入樂譜

GET    /api/collaboration/sessions/:scoreId  # 獲取協作會話
POST   /api/collaboration/sessions/:scoreId  # 加入協作會話
```

### 5.2 WebSocket 事件
```typescript
// 客戶端發送事件
interface ClientEvents {
  'join-session': { scoreId: string; userId: string };
  'leave-session': { sessionId: string };
  'operation': Operation;
  'cursor-update': { position: EditorCursor };
}

// 伺服器發送事件
interface ServerEvents {
  'session-joined': { session: CollaborationSession };
  'user-joined': { user: User };
  'user-left': { userId: string };
  'operation-applied': { operation: Operation };
  'cursor-updated': { userId: string; position: EditorCursor };
  'conflict-detected': { operations: Operation[] };
}
```

## 6. 轉調系統設計

### 6.1 調性轉換引擎
```typescript
class TranspositionEngine {
  private intervals: Map<string, number> = new Map([
    ['C', 0], ['C#', 1], ['Db', 1], ['D', 2], ['D#', 3], ['Eb', 3],
    ['E', 4], ['F', 5], ['F#', 6], ['Gb', 6], ['G', 7], ['G#', 8],
    ['Ab', 8], ['A', 9], ['A#', 10], ['Bb', 10], ['B', 11]
  ]);
  
  transpose(note: Note, semitones: number): Note;
  transposeChord(chord: Chord, semitones: number): Chord;
  getKeySignature(key: string): KeySignature;
  getInstrumentTransposition(instrument: Instrument): number;
}
```

### 6.2 樂器轉調映射
```typescript
const INSTRUMENT_TRANSPOSITIONS = {
  'Bb-Clarinet': -2,    // 降二度
  'Bb-Trumpet': -2,     // 降二度
  'Eb-Alto-Sax': 3,     // 升小三度
  'F-Horn': -7,         // 降五度
  'Eb-Baritone-Sax': -9 // 降大六度
};
```

## 7. 匯出系統設計

### 7.1 格式轉換器架構
```typescript
interface FormatConverter {
  convert(score: Score, options: ConvertOptions): Promise<ConvertResult>;
  validate(score: Score): ValidationResult;
  getSupportedOptions(): ConvertOptions[];
}

class ABCConverter implements FormatConverter {
  convert(score: Score, options: ConvertOptions): Promise<string>;
}

class PDFConverter implements FormatConverter {
  convert(score: Score, options: ConvertOptions): Promise<Buffer>;
}

class MIDIConverter implements FormatConverter {
  convert(score: Score, options: ConvertOptions): Promise<Buffer>;
}
```

### 7.2 ABC Notation 轉換規則
```typescript
const ABC_MAPPING = {
  notes: {
    'C4': 'C', 'D4': 'D', 'E4': 'E', 'F4': 'F',
    'G4': 'G', 'A4': 'A', 'B4': 'B',
    'C5': 'c', 'D5': 'd', 'E5': 'e'
  },
  durations: {
    'whole': '4', 'half': '2', 'quarter': '1',
    'eighth': '1/2', 'sixteenth': '1/4'
  },
  accidentals: {
    'sharp': '^', 'flat': '_', 'natural': '='
  }
};
```

## 8. 性能優化設計

### 8.1 虛擬滾動
```typescript
class VirtualScroller {
  private viewportHeight: number;
  private itemHeight: number;
  private startIndex: number = 0;
  private endIndex: number = 0;
  
  calculateVisibleRange(): { start: number; end: number };
  renderVisibleItems(): VNode[];
}
```

### 8.2 懶載入策略
```typescript
class LazyLoader {
  private cache: Map<string, any> = new Map();
  private loading: Set<string> = new Set();
  
  async load<T>(key: string, loader: () => Promise<T>): Promise<T>;
  preload(keys: string[]): void;
  clearCache(): void;
}
```

## 9. 錯誤處理與恢復

### 9.1 錯誤類型定義
```typescript
enum ErrorType {
  NETWORK_ERROR = 'NETWORK_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  CONFLICT_ERROR = 'CONFLICT_ERROR',
  PERMISSION_ERROR = 'PERMISSION_ERROR'
}

interface AppError {
  type: ErrorType;
  message: string;
  code: number;
  details?: any;
  timestamp: Date;
}
```

### 9.2 自動恢復機制
```typescript
class RecoveryManager {
  private retryQueue: Operation[] = [];
  private maxRetries: number = 3;
  
  async handleError(error: AppError): Promise<void>;
  retryOperation(operation: Operation): Promise<boolean>;
  saveToLocalStorage(data: any): void;
  restoreFromLocalStorage(): any;
}
```

## 10. 測試策略

### 10.1 單元測試覆蓋
- 樂譜資料模型測試
- 轉調引擎測試
- 格式轉換器測試
- 狀態管理測試

### 10.2 整合測試
- WebSocket 連接測試
- 協作功能測試
- 匯出匯入測試

### 10.3 端到端測試
- 用戶工作流程測試
- 跨瀏覽器相容性測試
- 性能基準測試
