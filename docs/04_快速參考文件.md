# BandPro 開發快速參考

## AI 階段性指令速查表

### 第一階段：項目初始化
```bash
# 使用指令：創建 Vue 3 + TypeScript + Vite 項目
請創建 BandPro 樂團團譜系統的基礎項目架構，包含：
1. Vue 3 + TypeScript + Vite 配置
2. ESLint + Prettier 代碼規範
3. Pinia 狀態管理
4. Vue Router 路由配置
5. 基礎 UI 組件（Button, Input, Modal）
6. 響應式 CSS 架構
```

### 第二階段：資料模型與渲染器
```bash
# 使用指令：實現樂譜核心功能
基於 SA 文件的資料模型設計，請實現：
1. 完整的樂譜 TypeScript 類型定義
2. ScoreStore Pinia 狀態管理
3. Canvas/SVG 五線譜渲染器
4. 基礎音符顯示功能
5. 音樂理論計算工具函數
```

### 第三階段：編輯功能
```bash
# 使用指令：實現音符編輯功能
請實現樂譜的交互編輯功能：
1. 音符輸入工具欄
2. 滑鼠點擊添加/選擇音符
3. 鍵盤快捷鍵支援
4. 撤銷/重做命令模式
5. 音符屬性編輯（時值、升降記號）
```

### 第四階段：多樂器支援
```bash
# 使用指令：實現多樂器功能
請實現樂團多聲部功能：
1. 樂器配置系統（含音域、譜表類型）
2. 聲部管理組件
3. 不同譜表渲染（高音、低音、中音譜表）
4. 樂器選擇和切換界面
5. 聲部間的切換和管理
```

### 第五階段：轉調系統
```bash
# 使用指令：實現轉調功能
請實現即時轉調系統：
1. 轉調核心算法（十二平均律）
2. 調號自動更新
3. 移調樂器處理（Bb、Eb、F調樂器）
4. 轉調 UI 面板
5. 轉調預覽和確認功能
```

### 第六階段：基礎匯出
```bash
# 使用指令：實現匯出功能
請實現樂譜匯出功能：
1. JSON 格式匯出
2. ABC Notation 轉換器
3. 匯出對話框和選項設置
4. 檔案下載功能
5. 匯出格式預覽
```

### 第七階段：匯入功能
```bash
# 使用指令：實現匯入功能
請實現樂譜匯入功能：
1. JSON 格式匯入和解析
2. 檔案上傳組件
3. 資料驗證和錯誤處理
4. 匯入預覽和確認
5. 格式兼容性檢查
```

### 第八階段：協作基礎
```bash
# 使用指令：實現即時協作
請實現多人協作基礎架構：
1. WebSocket 通訊層
2. 操作同步和廣播機制
3. 用戶游標顯示
4. 基礎衝突檢測和解決
5. 協作狀態指示器
```

### 第九階段：協作完善
```bash
# 使用指令：完善協作功能
請完善協作用戶體驗：
1. 用戶權限和角色管理
2. 協作面板 UI
3. 用戶邀請和會話管理
4. 操作歷史記錄
5. 離線支援機制
```

### 第十階段：PDF 匯出
```bash
# 使用指令：實現 PDF 匯出
請實現專業的 PDF 匯出功能：
1. PDF 生成庫整合
2. 樂譜自動排版算法
3. 列印預覽功能
4. 頁面設置和格式化
5. 多種紙張大小支援
```

### 第十一階段：性能優化
```bash
# 使用指令：性能優化和響應式
請優化系統性能和移動端適配：
1. 虛擬滾動實現
2. Canvas 渲染性能優化
3. 移動端響應式界面
4. 觸控手勢支援
5. 懶載入機制
```

### 第十二階段：測試部署
```bash
# 使用指令：完善測試和部署
請完善測試和部署配置：
1. 補充單元測試（目標覆蓋率 80%+）
2. E2E 測試場景
3. 構建優化和配置
4. Docker 部署配置
5. CI/CD 流程設置
```

---

## 核心技術棧

### 前端框架
- **Vue 3** - 組合式 API
- **TypeScript** - 類型安全
- **Vite** - 構建工具
- **Pinia** - 狀態管理
- **Vue Router** - 路由管理

### UI 和渲染
- **Canvas API** - 樂譜渲染
- **CSS Grid/Flexbox** - 響應式佈局
- **Web Components** - 可重用組件

### 即時協作
- **WebSocket** - 實時通訊
- **Operational Transformation** - 衝突解決
- **IndexedDB** - 本地存儲

### 匯出匯入
- **jsPDF** - PDF 生成
- **File API** - 檔案處理
- **Web Workers** - 後台處理

---

## 資料結構速查

### 基礎樂譜結構
```typescript
interface Score {
  id: string;
  title: string;
  composer?: string;
  keySignature: string;    // "C", "G", "D", "A", "E", "B", "F#", "Db", "Ab", "Eb", "Bb", "F"
  timeSignature: string;   // "4/4", "3/4", "2/4", "6/8", etc.
  tempo: number;           // BPM
  parts: Part[];
}

interface Part {
  id: string;
  instrument: string;
  instrumentFamily: InstrumentFamily;
  clef: ClefType;          // "treble", "bass", "alto", "tenor"
  transposition: number;   // 半音數
  measures: Measure[];
}

interface Note {
  id: string;
  pitch: string;           // "C4", "D#5", "Bb3"
  duration: NoteDuration;  // "whole", "half", "quarter", "eighth", "sixteenth"
  accidental?: Accidental; // "sharp", "flat", "natural"
  dotted: boolean;
  tied: boolean;
  position: number;        // 在小節中的位置
}
```

### 轉調對照表
```typescript
const KEY_SIGNATURES = {
  'C': { sharps: 0, flats: 0 },
  'G': { sharps: 1, flats: 0 },   // F#
  'D': { sharps: 2, flats: 0 },   // F#, C#
  'A': { sharps: 3, flats: 0 },   // F#, C#, G#
  'E': { sharps: 4, flats: 0 },   // F#, C#, G#, D#
  'B': { sharps: 5, flats: 0 },   // F#, C#, G#, D#, A#
  'F#': { sharps: 6, flats: 0 },  // F#, C#, G#, D#, A#, E#
  'F': { sharps: 0, flats: 1 },   // Bb
  'Bb': { sharps: 0, flats: 2 },  // Bb, Eb
  'Eb': { sharps: 0, flats: 3 },  // Bb, Eb, Ab
  'Ab': { sharps: 0, flats: 4 },  // Bb, Eb, Ab, Db
  'Db': { sharps: 0, flats: 5 },  // Bb, Eb, Ab, Db, Gb
  'Gb': { sharps: 0, flats: 6 }   // Bb, Eb, Ab, Db, Gb, Cb
};
```

### 樂器轉調表
```typescript
const INSTRUMENT_TRANSPOSITIONS = {
  // 非移調樂器（音高樂器）
  'Piano': 0,
  'Violin': 0,
  'Viola': 0,
  'Cello': 0,
  'Flute': 0,
  'Oboe': 0,
  
  // Bb調樂器（降二度）
  'Bb-Clarinet': -2,
  'Bb-Trumpet': -2,
  'Bb-Tenor-Sax': -2,
  
  // Eb調樂器（升小三度）
  'Eb-Alto-Sax': 3,
  'Eb-Baritone-Sax': -9, // 降大六度 + 八度
  
  // F調樂器（降五度）
  'F-Horn': -7
};
```

---

## 常用音樂理論函數

```typescript
// 音符轉換為 MIDI 音高
function noteToMidi(note: string): number {
  const noteMap = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };
  const match = note.match(/^([A-G])([#b]?)(\d+)$/);
  if (!match) return 60; // 默認 C4
  
  const [, noteName, accidental, octave] = match;
  let midiNote = noteMap[noteName] + (parseInt(octave) + 1) * 12;
  
  if (accidental === '#') midiNote++;
  if (accidental === 'b') midiNote--;
  
  return midiNote;
}

// MIDI 音高轉換為音符
function midiToNote(midi: number): string {
  const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  const octave = Math.floor(midi / 12) - 1;
  const noteIndex = midi % 12;
  return `${notes[noteIndex]}${octave}`;
}

// 轉調函數
function transposeNote(note: string, semitones: number): string {
  const midi = noteToMidi(note);
  return midiToNote(midi + semitones);
}

// 計算音程
function getInterval(note1: string, note2: string): number {
  return noteToMidi(note2) - noteToMidi(note1);
}
```

---

## 測試範例

### 單元測試模板
```typescript
// 音符轉調測試
describe('Transposition', () => {
  test('transpose C4 up a whole tone', () => {
    expect(transposeNote('C4', 2)).toBe('D4');
  });
  
  test('transpose with accidentals', () => {
    expect(transposeNote('F#4', -1)).toBe('F4');
  });
  
  test('transpose across octave', () => {
    expect(transposeNote('B3', 2)).toBe('C#4');
  });
});

// 樂譜狀態管理測試
describe('ScoreStore', () => {
  test('add note to measure', () => {
    const store = useScoreStore();
    store.addNote('measure1', {
      id: 'note1',
      pitch: 'C4',
      duration: 'quarter',
      position: 0
    });
    
    expect(store.getMeasure('measure1').notes).toHaveLength(1);
  });
});
```

### E2E 測試場景
```typescript
// 樂譜編輯流程測試
describe('Score Editing Flow', () => {
  test('create and edit a simple melody', () => {
    cy.visit('/editor');
    cy.get('[data-testid="new-score"]').click();
    cy.get('[data-testid="score-title"]').type('My First Score');
    
    // 添加音符
    cy.get('[data-testid="quarter-note-tool"]').click();
    cy.get('[data-testid="staff-area"]').click(100, 200);
    cy.get('[data-testid="staff-area"]').click(150, 200);
    
    // 驗證音符已添加
    cy.get('[data-testid="note"]').should('have.length', 2);
    
    // 轉調測試
    cy.get('[data-testid="transpose-button"]').click();
    cy.get('[data-testid="key-selector"]').select('D');
    cy.get('[data-testid="apply-transpose"]').click();
    
    // 匯出測試
    cy.get('[data-testid="export-button"]').click();
    cy.get('[data-testid="export-json"]').click();
    cy.readFile('downloads/my-first-score.json').should('exist');
  });
});
```

---

## 部署檢查清單

### 開發環境檢查
- [ ] Node.js 版本 >= 18
- [ ] Vue DevTools 已安裝
- [ ] TypeScript 編譯無錯誤
- [ ] ESLint 檢查通過
- [ ] 單元測試覆蓋率 >= 80%

### 生產環境檢查
- [ ] 構建產物優化（Tree shaking）
- [ ] 靜態資源壓縮
- [ ] HTTPS 配置
- [ ] 快取策略設置
- [ ] 錯誤監控配置
- [ ] 性能監控設置

### 功能驗收檢查
- [ ] 樂譜創建和編輯
- [ ] 多樂器聲部管理
- [ ] 即時轉調功能
- [ ] 多格式匯出匯入
- [ ] 多人即時協作
- [ ] 響應式界面適配

這份快速參考文件可以幫助您在開發過程中快速查找所需的指令、API 和配置信息。
