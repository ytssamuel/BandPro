# BandPro 第一階段架構 - 小型工作室方案

適用對象：個人開發者、小型工作室、概念驗證
用戶規模：1-10 用戶
預算範圍：$0-50/月

## 🎯 階段目標

- 快速啟動和驗證產品概念
- 最小化初期投資和運營成本
- 建立可擴展的基礎架構
- 為下一階段做好技術準備

---

## 1. 整體架構設計

### 1.1 簡化系統架構
```mermaid
flowchart TD
    subgraph UserSide[用戶端]
        Browser[瀏覽器<br/>Vue.js PWA]
        Mobile[手機瀏覽器<br/>響應式]
    end
    
    subgraph FreeHosting[免費託管服務]
        Vercel[Vercel<br/>前端託管<br/>免費方案]
        Railway[Railway<br/>後端託管<br/>$5/月]
    end
    
    subgraph BackendService[後端服務單體架構]
        Express[Express.js API<br/>所有功能合一]
        SocketIO[Socket.IO<br/>即時協作]
    end
    
    subgraph DataLayer[資料層]
        MongoDB[MongoDB Atlas<br/>免費512MB]
        Redis[Upstash Redis<br/>免費10k請求/天]
    end
    
    subgraph FileStorage[檔案儲存]
        Cloudinary[Cloudinary<br/>免費10GB]
    end
    
    Browser --> Vercel
    Mobile --> Vercel
    Vercel --> Railway
    Railway --> Express
    Express --> SocketIO
    Express --> MongoDB
    SocketIO --> Redis
    Express --> Cloudinary
```

### 1.2 技術選型 (免費優先)
```mermaid
mindmap
  root((BandPro 第一階段))
    前端開發
      Vue.js 3
      TypeScript
      Vite
      Pinia
      PWA Support
    後端開發  
      Node.js
      Express.js
      Socket.IO
      Mongoose ODM
    資料儲存
      MongoDB Atlas 免費
      Upstash Redis 免費
      LocalStorage 快取
    檔案服務
      Cloudinary 免費
      本地檔案快取
    部署服務
      Vercel 前端
      Railway 後端
      GitHub Actions CI/CD
```

---

## 2. 詳細技術規劃

### 2.1 前端架構
```mermaid
flowchart LR
    subgraph VueApp[Vue.js應用]
        subgraph CoreLayer[核心層]
            Router[Vue Router<br/>路由管理]
            Store[Pinia<br/>狀態管理]
            PWA[PWA<br/>離線支援]
        end
        
        subgraph PageComponents[頁面組件]
            Login[登入頁]
            Dashboard[儀表板]
            Editor[樂譜編輯器]
            Collab[協作頁面]
        end
        
        subgraph FunctionComponents[功能組件]
            StaffRenderer[五線譜渲染<br/>Canvas API]
            NoteInput[音符輸入]
            Toolbar[工具欄]
            ExportDialog[匯出對話框]
        end
        
        subgraph UtilsLayer[工具層]
            MusicTheory[音樂理論<br/>本地計算]
            ABCParser[ABC 解析器]
            FileHandler[檔案處理]
        end
    end
    
    Router --> Dashboard
    Store --> Editor
    PWA --> Login
    Editor --> StaffRenderer
    Editor --> NoteInput
    Editor --> Toolbar
    Dashboard --> ExportDialog
    StaffRenderer --> MusicTheory
    ExportDialog --> ABCParser
    NoteInput --> FileHandler
```

### 2.2 後端架構 (單體設計)
```mermaid
flowchart TD
    subgraph ExpressApp[Express.js應用]
        subgraph RouteLayer[路由層]
            AuthRoutes[認證路由<br/>/api/auth]
            ScoreRoutes[樂譜路由<br/>/api/scores]
            UserRoutes[用戶路由<br/>/api/users]
            CollabRoutes[協作路由<br/>/api/collab]
        end
        
        subgraph MiddlewareLayer[中間件層]
            CORS[CORS 處理]
            Auth[JWT 認證]
            RateLimit[速率限制<br/>記憶體存儲]
            ErrorHandler[錯誤處理]
        end
        
        subgraph BusinessLogicLayer[業務邏輯層]
            AuthService[認證服務]
            ScoreService[樂譜服務]
            CollabService[協作服務]
            ExportService[匯出服務]
        end
        
        subgraph DataAccessLayer[資料訪問層]
            MongooseModels[Mongoose 模型]
            RedisClient[Redis 客戶端]
            FileUpload[檔案上傳]
        end
        
        subgraph RealtimeComm[即時通訊]
            SocketIOServer[Socket.IO 服務器]
            RoomManager[房間管理]
            EventHandlers[事件處理器]
        end
    end
    
    AuthRoutes --> AuthService
    ScoreRoutes --> ScoreService
    CollabRoutes --> CollabService
    
    CORS --> Auth
    Auth --> RateLimit
    RateLimit --> ErrorHandler
    
    AuthService --> MongooseModels
    ScoreService --> MongooseModels
    CollabService --> RedisClient
    ExportService --> FileUpload
    
    CollabService --> SocketIOServer
    SocketIOServer --> RoomManager
    RoomManager --> EventHandlers
```

---

## 3. 資料庫設計

### 3.1 MongoDB 集合設計
```mermaid
erDiagram
    Users ||--o{ Scores : creates
    Users ||--o{ CollaborationSessions : participates
    Scores ||--o{ CollaborationSessions : has
    Scores ||--o{ ScoreVersions : versions
    
    Users {
        ObjectId _id PK
        string email UK
        string username
        string passwordHash
        string avatar
        array preferences
        timestamp createdAt
        timestamp updatedAt
    }
    
    Scores {
        ObjectId _id PK
        ObjectId userId FK
        string title
        string composer
        string keySignature
        string timeSignature
        number tempo
        object parts
        object metadata
        timestamp createdAt
        timestamp updatedAt
        number version
    }
    
    CollaborationSessions {
        ObjectId _id PK
        ObjectId scoreId FK
        array participants
        object state
        boolean active
        timestamp createdAt
        timestamp lastActivity
    }
    
    ScoreVersions {
        ObjectId _id PK
        ObjectId scoreId FK
        object snapshot
        string description
        timestamp createdAt
    }
```

### 3.2 Redis 資料結構
```mermaid
flowchart LR
    subgraph RedisCache[Redis快取策略]
        subgraph SessionMgmt[會話管理]
            Sessions["user:session:{userId}"<br/>JWT Token 資訊<br/>TTL: 24小時]
        end
        
        subgraph CollabState[協作狀態]
            CollabRooms["collab:room:{scoreId}"<br/>線上用戶列表<br/>TTL: 30分鐘]
            UserCursors["collab:cursor:{userId}"<br/>用戶游標位置<br/>TTL: 5分鐘]
        end
        
        subgraph CacheData[快取資料]
            ScoreCache["cache:score:{scoreId}"<br/>樂譜快照<br/>TTL: 1小時]
            UserProfile["cache:user:{userId}"<br/>用戶資料<br/>TTL: 30分鐘]
        end
    end
    
    Sessions --> CollabRooms
    CollabRooms --> UserCursors
    UserCursors --> ScoreCache
    ScoreCache --> UserProfile
```

---

## 4. 部署架構

### 4.1 免費託管方案
```mermaid
flowchart TB
    subgraph DevEnv[開發環境]
        LocalDev[本地開發<br/>Node.js & MongoDB 本地]
        GitHub[GitHub<br/>程式碼版本控制<br/>免費私有倉庫]
    end
    
    subgraph CICD[CI/CD]
        GitHubActions[GitHub Actions<br/>自動化部署<br/>免費 2000 分鐘/月]
        ESLint[程式碼檢查<br/>ESLint & Prettier]
        Tests[單元測試<br/>Jest & Vitest]
    end
    
    subgraph ProdEnv[生產環境]
        VercelFrontend[Vercel<br/>前端託管<br/>免費 100GB 頻寬/月]
        RailwayBackend[Railway<br/>後端託管<br/>$5/月 512MB RAM]
        MongoAtlas[MongoDB Atlas<br/>免費 512MB 儲存]
        UpstashRedis[Upstash Redis<br/>免費 10k 請求/天]
        Cloudinary[Cloudinary<br/>免費 10GB 檔案儲存]
    end
    
    subgraph DomainSec[域名與安全]
        CloudflareDNS[Cloudflare<br/>免費 DNS & SSL]
        CustomDomain[自訂域名<br/>$10-15/年]
    end
    
    LocalDev --> GitHub
    GitHub --> GitHubActions
    GitHubActions --> ESLint
    GitHubActions --> Tests
    GitHubActions --> VercelFrontend
    GitHubActions --> RailwayBackend
    
    RailwayBackend --> MongoAtlas
    RailwayBackend --> UpstashRedis
    RailwayBackend --> Cloudinary
    
    VercelFrontend --> CloudflareDNS
    RailwayBackend --> CloudflareDNS
    CloudflareDNS --> CustomDomain
```

### 4.2 成本結構 (月費)
```mermaid
pie title 第一階段月費預估 ($30/月)
    "Railway 後端託管" : 5
    "域名費用 (年費分攤)" : 1
    "MongoDB Atlas" : 0
    "Vercel 前端託管" : 0
    "Upstash Redis" : 0
    "Cloudinary 檔案" : 0
    "GitHub Actions" : 0
    "Cloudflare DNS" : 0
    "預留緩衝" : 24
```

---

## 5. 功能實現策略

### 5.1 MVP 功能優先級
```mermaid
flowchart TD
    subgraph Priority1[第一優先級立即實現]
        UserAuth[用戶註冊登入]
        BasicEditor[基礎樂譜編輯]
        LocalSave[本地自動儲存]
        JSONExport[JSON 格式匯出]
    end
    
    subgraph Priority2[第二優先級1-2周內]
        BasicCollab[基礎協作功能]
        ABCExport[ABC Notation 匯出]
        SimpleTranspose[基礎轉調功能]
        FileImport[檔案匯入功能]
    end
    
    subgraph Priority3[第三優先級1個月內]
        PDFExport[PDF 匯出]
        AdvancedEditor[進階編輯功能]
        UserProfiles[用戶個人檔案]
        ScoreSharing[樂譜分享功能]
    end
    
    subgraph Priority4[第四優先級2-3個月內]
        MobileOptimization[手機版優化]
        OfflineMode[離線模式PWA]
        AdvancedCollab[進階協作功能]
        PerformanceOpt[性能優化]
    end
    
    UserAuth --> BasicEditor
    BasicEditor --> LocalSave
    LocalSave --> JSONExport
    JSONExport --> BasicCollab
    BasicCollab --> ABCExport
    ABCExport --> SimpleTranspose
    SimpleTranspose --> FileImport
```

### 5.2 技術債務管理
```mermaid
mindmap
  root((技術債務))
    架構債務
      單體架構限制
      資料庫設計優化
      快取策略改進
    程式碼債務
      程式碼重構需求
      測試覆蓋率提升
      文件完善
    性能債務
      前端優化機會
      資料庫查詢優化
      檔案處理效能
    安全債務
      認證機制強化
      輸入驗證加強
      錯誤處理改善
```

---

## 6. 監控與維護

### 6.1 基礎監控方案
```mermaid
flowchart LR
    subgraph FrontendMonitor[前端監控]
        BrowserErrors[瀏覽器錯誤<br/>Console.error 捕獲]
        UserAnalytics[用戶行為<br/>Google Analytics 免費]
        PerformanceAPI[性能指標<br/>Web Vitals]
    end
    
    subgraph BackendMonitor[後端監控]
        AppLogs[應用程式日誌<br/>Winston &amp; Railway 日誌]
        HealthCheck[健康檢查<br/>Express 端點]
        ErrorTracking[錯誤追蹤<br/>Try-catch 包裝]
    end
    
    subgraph DatabaseMonitor[資料庫監控]
        MongoMetrics[MongoDB Atlas<br/>內建監控免費]
        RedisMetrics[Upstash<br/>內建儀表板]
    end
    
    subgraph AlertMechanism[告警機制]
        EmailAlerts[Email 通知<br/>免費SMTP]
        SlackBot[Slack 通知<br/>免費方案]
        StatusPage[狀態頁面<br/>簡單HTML]
    end
    
    BrowserErrors --> EmailAlerts
    AppLogs --> SlackBot
    MongoMetrics --> StatusPage
    HealthCheck --> EmailAlerts
```

### 6.2 備份策略
```mermaid
flowchart TD
    subgraph DataBackup[資料備份]
        MongoBackup[MongoDB Atlas<br/>自動備份免費<br/>7天保留]
        CodeBackup[GitHub<br/>程式碼版本控制<br/>無限制]
        ConfigBackup[配置檔案<br/>環境變數文檔化]
    end
    
    subgraph FileBackup[檔案備份]
        CloudinaryBackup[Cloudinary<br/>檔案自動備份]
        LocalExport[定期匯出<br/>JSON格式備份]
        UserData[用戶資料匯出<br/>GDPR合規]
    end
    
    subgraph RecoveryTest[恢復測試]
        WeeklyTest[每周恢復測試<br/>自動化腳本]
        DisasterPlan[災難恢復計劃<br/>文檔化流程]
        BackupVerify[備份完整性驗證]
    end
    
    MongoBackup --> WeeklyTest
    CloudinaryBackup --> DisasterPlan
    LocalExport --> BackupVerify
```

---

## 7. 擴展觸發條件

### 7.1 升級到第二階段的信號
```mermaid
flowchart TD
    subgraph UserGrowthMetrics[用戶增長指標]
        ActiveUsers[日活躍用戶20+]
        Registrations[新註冊用戶5+/天]
        CollabSessions[協作會話10+/天]
    end
    
    subgraph TechnicalBottlenecks[技術瓶頸]
        ResponseTime[API響應時間1秒+]
        DatabaseSize[資料庫使用400MB+]
        ConcurrentUsers[同時線上15+]
    end
    
    subgraph BusinessNeeds[業務需求]
        Revenue[月營收$100+]
        FeatureRequests[新功能需求增多]
        SupportLoad[技術支援負載增加]
    end
    
    ActiveUsers --> NextStage[準備升級到第二階段]
    ResponseTime --> NextStage
    Revenue --> NextStage
    
    NextStage --> Planning[制定遷移計劃]
    Planning --> Implementation[執行第二階段]
```

---

## 8. 風險評估

### 8.1 技術風險
| 風險類型 | 可能性 | 影響程度 | 緩解措施 |
|---------|--------|----------|----------|
| **免費服務限制** | 高 | 中 | 監控使用量，準備升級計劃 |
| **單點故障** | 中 | 高 | 快速恢復程序，資料備份 |
| **性能瓶頸** | 中 | 中 | 程式碼優化，快取策略 |
| **資料遺失** | 低 | 高 | 多重備份，版本控制 |

### 8.2 業務風險
| 風險類型 | 可能性 | 影響程度 | 緩解措施 |
|---------|--------|----------|----------|
| **用戶增長停滯** | 中 | 高 | 產品迭代，用戶回饋 |
| **競爭對手** | 高 | 中 | 差異化功能，快速迭代 |
| **技術債務累積** | 高 | 中 | 定期重構，程式碼審查 |
| **團隊擴展困難** | 低 | 中 | 文件化，標準化流程 |

---

## 9. 實施時程

### 9.1 四週衝刺計劃
```mermaid
gantt
    title BandPro 第一階段實施時程
    dateFormat  YYYY-MM-DD
    section 第1週：基礎架構
    環境設置           :done,    setup, 2024-01-01, 2d
    後端API開發        :active,  backend, 2024-01-03, 5d
    section 第2週：前端開發
    Vue.js應用         :frontend, 2024-01-08, 5d
    樂譜編輯器         :editor, after frontend, 3d
    section 第3週：核心功能
    用戶認證           :auth, 2024-01-15, 3d
    檔案處理           :files, after auth, 2d
    基礎協作           :collab, after files, 2d
    section 第4週：測試部署
    整合測試           :testing, 2024-01-22, 3d
    生產部署           :deploy, after testing, 2d
    文件撰寫           :docs, after deploy, 2d
```

---

## 10. 總結與下一步

### 10.1 第一階段目標達成標準
- ✅ 系統成功上線並可正常訪問
- ✅ 基本樂譜編輯功能可用
- ✅ 用戶註冊登入流程完整
- ✅ 檔案匯出匯入功能正常
- ✅ 基礎協作功能可用
- ✅ 月運營成本控制在 $30 以內
- ✅ 系統響應時間 < 2秒
- ✅ 支援 5-10 個並發用戶

### 10.2 為第二階段做準備
1. **監控關鍵指標**：用戶增長、系統性能、業務指標
2. **收集用戶回饋**：功能需求、使用體驗、痛點分析
3. **技術債務管理**：持續重構、測試覆蓋率、文件更新
4. **資源準備**：團隊擴展、預算規劃、技術升級

👉 **當觸發升級條件時，請參考 [第二階段架構-成長期方案](./08_第二階段架構-成長期方案.md)**
