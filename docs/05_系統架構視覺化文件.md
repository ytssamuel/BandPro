# BandPro 系統架構視覺化文件

本文件提供 BandPro 樂團團譜打譜系統的各種架構圖表，幫助理解系統設計和流程。

---

## 1. 系統整體架構圖

### 1.1 分層架構圖
```mermaid
graph TD
    subgraph "用戶層"
        U1[樂團指揮]
        U2[樂器演奏者]
        U3[音樂編曲師]
        U4[音樂教師]
    end
    
    subgraph "前端層 (Vue.js)"
        V1[樂譜編輯器]
        V2[協作面板]
        V3[匯出匯入]
        V4[用戶介面]
    end
    
    subgraph "通訊層"
        W1[WebSocket 即時通訊]
        W2[HTTP REST API]
    end
    
    subgraph "業務邏輯層"
        B1[樂譜管理]
        B2[協作服務]
        B3[轉調引擎]
        B4[格式轉換器]
    end
    
    subgraph "資料層"
        D1[(用戶資料)]
        D2[(樂譜資料)]
        D3[(協作會話)]
        D4[(操作日誌)]
    end
    
    U1 --> V1
    U2 --> V2
    U3 --> V3
    U4 --> V4
    
    V1 --> W1
    V2 --> W1
    V3 --> W2
    V4 --> W2
    
    W1 --> B2
    W2 --> B1
    W2 --> B3
    W2 --> B4
    
    B1 --> D2
    B2 --> D1
    B2 --> D3
    B3 --> D2
    B4 --> D2
    B2 --> D4
```

### 1.2 前端模組架構圖
```mermaid
graph LR
    subgraph "Vue 應用程式"
        subgraph "組件層"
            C1[通用組件<br/>Common]
            C2[編輯器組件<br/>Editor]
            C3[協作組件<br/>Collaboration]
            C4[匯出組件<br/>Export]
        end
        
        subgraph "狀態管理層"
            S1[ScoreStore<br/>樂譜狀態]
            S2[CollaborationStore<br/>協作狀態]
            S3[UserStore<br/>用戶狀態]
            S4[ExportStore<br/>匯出狀態]
        end
        
        subgraph "服務層"
            SV1[WebSocket 服務]
            SV2[API 服務]
            SV3[檔案服務]
        end
        
        subgraph "工具層"
            U1[音樂理論工具]
            U2[轉調工具]
            U3[格式轉換器]
            U4[檔案處理器]
        end
    end
    
    C2 --> S1
    C3 --> S2
    C4 --> S4
    
    S1 --> SV2
    S2 --> SV1
    S4 --> SV3
    
    S1 --> U1
    S1 --> U2
    S4 --> U3
    SV3 --> U4
```

---

## 2. 資料模型關係圖

### 2.1 樂譜資料模型 ER 圖
```mermaid
erDiagram
    Score {
        string id PK
        string title
        string composer
        string keySignature
        string timeSignature
        number tempo
        datetime created
        datetime modified
        number version
    }
    
    Part {
        string id PK
        string scoreId FK
        string instrument
        string instrumentFamily
        string clef
        number transposition
    }
    
    Measure {
        string id PK
        string partId FK
        number number
    }
    
    Note {
        string id PK
        string measureId FK
        string pitch
        string duration
        string accidental
        boolean dotted
        boolean tied
        number position
    }
    
    Rest {
        string id PK
        string measureId FK
        string duration
        number position
    }
    
    Dynamic {
        string id PK
        string measureId FK
        string type
        number position
    }
    
    Articulation {
        string id PK
        string noteId FK
        string type
    }
    
    Score ||--o{ Part : contains
    Part ||--o{ Measure : contains
    Measure ||--o{ Note : contains
    Measure ||--o{ Rest : contains
    Measure ||--o{ Dynamic : contains
    Note ||--o{ Articulation : has
```

### 2.2 協作系統資料模型
```mermaid
erDiagram
    CollaborationSession {
        string id PK
        string scoreId FK
        datetime created
        boolean active
    }
    
    User {
        string id PK
        string name
        string email
        string role
        string color
        boolean online
    }
    
    SessionUser {
        string sessionId FK
        string userId FK
        array permissions
        datetime joinedAt
    }
    
    Operation {
        string id PK
        string sessionId FK
        string userId FK
        string type
        string target
        object data
        datetime timestamp
        boolean applied
    }
    
    Cursor {
        string userId FK
        string sessionId FK
        string partId
        string measureId
        number position
        datetime updated
    }
    
    CollaborationSession ||--o{ SessionUser : has
    User ||--o{ SessionUser : joins
    CollaborationSession ||--o{ Operation : contains
    User ||--o{ Operation : performs
    User ||--o| Cursor : has
```

---

## 3. 系統流程圖

### 3.1 用戶操作主流程
```mermaid
flowchart TD
    Start([用戶開始]) --> Login{是否登入?}
    Login -->|否| Auth[用戶認證]
    Auth --> Dashboard[樂譜儀表板]
    Login -->|是| Dashboard
    
    Dashboard --> Action{選擇操作}
    
    Action -->|新建樂譜| Create[創建新樂譜]
    Action -->|開啟現有| Open[開啟樂譜]
    Action -->|匯入檔案| Import[匯入樂譜]
    
    Create --> Editor[進入編輯器]
    Open --> Editor
    Import --> Validate{驗證檔案}
    Validate -->|成功| Editor
    Validate -->|失敗| Error[顯示錯誤]
    Error --> Dashboard
    
    Editor --> EditAction{編輯操作}
    
    EditAction -->|添加音符| AddNote[添加音符]
    EditAction -->|轉調| Transpose[執行轉調]
    EditAction -->|協作| Collaborate[開始協作]
    EditAction -->|匯出| Export[匯出樂譜]
    
    AddNote --> AutoSave[自動儲存]
    Transpose --> AutoSave
    Collaborate --> CollabFlow[協作流程]
    Export --> ExportFlow[匯出流程]
    
    AutoSave --> Editor
    CollabFlow --> Editor
    ExportFlow --> Editor
```

### 3.2 協作工作流程
```mermaid
flowchart TD
    Start([用戶加入協作]) --> CheckSession{會話是否存在?}
    
    CheckSession -->|否| CreateSession[創建協作會話]
    CheckSession -->|是| JoinSession[加入現有會話]
    
    CreateSession --> InitWS[初始化 WebSocket]
    JoinSession --> InitWS
    
    InitWS --> SyncState[同步當前狀態]
    SyncState --> ShowUsers[顯示線上用戶]
    ShowUsers --> Ready[準備接受操作]
    
    Ready --> UserAction{用戶操作}
    
    UserAction -->|編輯操作| LocalApply[本地立即套用]
    UserAction -->|游標移動| UpdateCursor[更新游標位置]
    UserAction -->|離開會話| LeaveSession[離開會話]
    
    LocalApply --> BroadcastOp[廣播操作]
    UpdateCursor --> BroadcastCursor[廣播游標]
    
    BroadcastOp --> ConflictCheck{檢查衝突?}
    ConflictCheck -->|無衝突| ApplyToOthers[套用至其他用戶]
    ConflictCheck -->|有衝突| ResolveConflict[解決衝突]
    
    ResolveConflict --> ApplyToOthers
    ApplyToOthers --> Ready
    BroadcastCursor --> Ready
    
    LeaveSession --> Cleanup[清理用戶狀態]
    Cleanup --> End([會話結束])
```

### 3.3 轉調處理流程
```mermaid
flowchart TD
    Start([開始轉調]) --> GetScore[獲取當前樂譜]
    GetScore --> SelectKey[選擇目標調性]
    
    SelectKey --> CalcInterval[計算轉調音程]
    CalcInterval --> ProcessParts[處理各聲部]
    
    ProcessParts --> PartLoop{遍歷聲部}
    
    PartLoop --> CheckInstrument[檢查樂器類型]
    CheckInstrument --> IsTransposing{是移調樂器?}
    
    IsTransposing -->|是| CalcTransposition[計算移調樂器補償]
    IsTransposing -->|否| ProcessNotes[直接處理音符]
    
    CalcTransposition --> ProcessNotes
    ProcessNotes --> TransposeNotes[轉調所有音符]
    
    TransposeNotes --> UpdateKey[更新調號]
    UpdateKey --> NextPart{還有聲部?}
    
    NextPart -->|是| PartLoop
    NextPart -->|否| ValidateResult[驗證轉調結果]
    
    ValidateResult --> Success{轉調成功?}
    Success -->|是| UpdateUI[更新用戶介面]
    Success -->|否| ShowError[顯示錯誤訊息]
    
    UpdateUI --> AutoSave[自動儲存]
    ShowError --> End([轉調結束])
    AutoSave --> End
```

### 3.4 匯出處理流程
```mermaid
flowchart TD
    Start([開始匯出]) --> SelectFormat[選擇匯出格式]
    
    SelectFormat --> FormatType{匯出格式}
    
    FormatType -->|JSON| JSONExport[JSON 序列化]
    FormatType -->|ABC| ABCConvert[ABC Notation 轉換]
    FormatType -->|PDF| PDFGenerate[PDF 生成]
    FormatType -->|MIDI| MIDIConvert[MIDI 轉換]
    FormatType -->|MusicXML| XMLConvert[MusicXML 轉換]
    
    JSONExport --> ValidateJSON[驗證 JSON]
    ABCConvert --> ValidateABC[驗證 ABC]
    PDFGenerate --> RenderPDF[渲染 PDF]
    MIDIConvert --> ValidateMIDI[驗證 MIDI]
    XMLConvert --> ValidateXML[驗證 XML]
    
    ValidateJSON --> Success{匯出成功?}
    ValidateABC --> Success
    RenderPDF --> Success
    ValidateMIDI --> Success
    ValidateXML --> Success
    
    Success -->|是| DownloadFile[下載檔案]
    Success -->|否| ShowError[顯示錯誤]
    
    DownloadFile --> End([匯出完成])
    ShowError --> End
```

---

## 4. 組件互動循序圖

### 4.1 樂譜編輯循序圖
```mermaid
sequenceDiagram
    participant U as 用戶
    participant E as ScoreEditor
    participant T as NoteInputToolbar
    participant R as StaffRenderer
    participant S as ScoreStore
    participant API as API服務
    
    U->>E: 開啟樂譜編輯器
    E->>S: 載入樂譜資料
    S->>API: GET /api/scores/:id
    API-->>S: 返回樂譜資料
    S-->>E: 樂譜資料
    E->>R: 渲染五線譜
    R-->>E: 顯示樂譜
    
    U->>T: 選擇四分音符工具
    T->>E: 設置當前工具
    E->>S: 更新編輯器狀態
    
    U->>R: 點擊五線譜位置
    R->>E: 觸發添加音符事件
    E->>S: 添加音符
    S->>S: 更新樂譜資料
    S-->>E: 觸發狀態更新
    E->>R: 重新渲染
    R-->>U: 顯示新音符
    
    Note over S: 自動儲存
    S->>API: PUT /api/scores/:id
    API-->>S: 儲存確認
```

### 4.2 即時協作循序圖
```mermaid
sequenceDiagram
    participant U1 as 用戶1
    participant U2 as 用戶2
    participant C1 as 協作組件1
    participant C2 as 協作組件2
    participant WS as WebSocket服務
    participant S as 協作伺服器
    
    U1->>C1: 加入協作會話
    C1->>WS: 建立 WebSocket 連接
    WS->>S: join-session 事件
    S-->>WS: session-joined 事件
    WS-->>C1: 會話資訊
    C1-->>U1: 顯示協作界面
    
    U2->>C2: 加入相同會話
    C2->>WS: 建立 WebSocket 連接
    WS->>S: join-session 事件
    S-->>WS: user-joined 事件 (廣播)
    WS-->>C1: 新用戶加入通知
    WS-->>C2: 會話資訊
    C1-->>U1: 顯示用戶2上線
    C2-->>U2: 顯示協作界面
    
    U1->>C1: 編輯音符
    C1->>C1: 本地立即套用
    C1->>WS: operation 事件
    WS->>S: 處理操作
    S->>S: 檢查衝突
    S-->>WS: operation-applied 事件 (廣播)
    WS-->>C2: 接收操作
    C2->>C2: 套用操作
    C2-->>U2: 更新樂譜顯示
    
    U1->>C1: 移動游標
    C1->>WS: cursor-update 事件
    WS->>S: 更新游標位置
    S-->>WS: cursor-updated 事件 (廣播)
    WS-->>C2: 游標位置更新
    C2-->>U2: 顯示用戶1游標
```

### 4.3 轉調操作循序圖
```mermaid
sequenceDiagram
    participant U as 用戶
    participant TP as TranspositionPanel
    participant TE as TranspositionEngine
    participant S as ScoreStore
    participant R as StaffRenderer
    
    U->>TP: 開啟轉調面板
    TP-->>U: 顯示當前調性和選項
    
    U->>TP: 選擇目標調性 (G大調)
    TP->>TE: 計算轉調參數
    TE->>TE: 計算音程差 (上升五度)
    TE-->>TP: 轉調參數
    
    U->>TP: 確認轉調
    TP->>S: 獲取樂譜資料
    S-->>TP: 樂譜資料
    
    TP->>TE: 執行轉調
    loop 處理每個聲部
        TE->>TE: 檢查樂器類型
        TE->>TE: 計算移調樂器補償
        TE->>TE: 轉調所有音符
        TE->>TE: 更新調號
    end
    TE-->>TP: 轉調完成
    
    TP->>S: 更新樂譜資料
    S->>R: 觸發重新渲染
    R-->>U: 顯示轉調後樂譜
    
    Note over S: 自動儲存轉調結果
```

### 4.4 匯出操作循序圖
```mermaid
sequenceDiagram
    participant U as 用戶
    participant ED as ExportDialog
    participant EE as ExportEngine
    participant C as 格式轉換器
    participant F as 檔案服務
    
    U->>ED: 開啟匯出對話框
    ED-->>U: 顯示匯出選項
    
    U->>ED: 選擇 ABC Notation 格式
    U->>ED: 設置匯出選項 (完整樂譜)
    U->>ED: 確認匯出
    
    ED->>EE: 開始匯出處理
    EE->>EE: 獲取樂譜資料
    EE->>C: 呼叫 ABC 轉換器
    
    C->>C: 解析樂譜結構
    C->>C: 轉換標題和元資料
    C->>C: 轉換調號和拍號
    loop 處理每個聲部
        C->>C: 轉換音符為 ABC 格式
        C->>C: 處理升降記號
        C->>C: 處理時值和節奏
    end
    C-->>EE: ABC 字串
    
    EE->>F: 生成下載檔案
    F->>F: 創建 Blob 物件
    F->>F: 生成下載連結
    F-->>EE: 下載連結
    
    EE-->>ED: 匯出完成
    ED->>F: 觸發下載
    F-->>U: 下載 ABC 檔案
```

---

## 5. 狀態管理架構圖

### 5.1 Pinia Store 關係圖
```mermaid
graph TD
    subgraph "應用程式狀態"
        subgraph "核心狀態 Store"
            SS[ScoreStore<br/>樂譜管理]
            CS[CollaborationStore<br/>協作管理]
            US[UserStore<br/>用戶管理]
            ES[ExportStore<br/>匯出管理]
        end
        
        subgraph "UI 狀態 Store"
            UI[UIStore<br/>界面狀態]
            TS[TranspositionStore<br/>轉調狀態]
            IS[InstrumentStore<br/>樂器配置]
        end
    end
    
    subgraph "外部服務"
        API[API 服務]
        WS[WebSocket 服務]
        FS[檔案服務]
    end
    
    SS --> API
    CS --> WS
    ES --> FS
    US --> API
    
    SS -.-> UI
    TS --> SS
    IS --> SS
    CS -.-> UI
```

### 5.2 狀態流轉圖
```mermaid
stateDiagram-v2
    [*] --> 應用初始化
    
    應用初始化 --> 用戶認證
    用戶認證 --> 樂譜列表 : 認證成功
    用戶認證 --> 登入頁面 : 認證失敗
    登入頁面 --> 用戶認證 : 重新登入
    
    樂譜列表 --> 樂譜編輯 : 選擇樂譜
    樂譜列表 --> 樂譜匯入 : 匯入檔案
    樂譜列表 --> 新建樂譜 : 建立新樂譜
    
    新建樂譜 --> 樂譜編輯
    樂譜匯入 --> 樂譜編輯 : 匯入成功
    樂譜匯入 --> 樂譜列表 : 匯入失敗
    
    state 樂譜編輯 {
        [*] --> 載入樂譜
        載入樂譜 --> 編輯模式
        編輯模式 --> 協作模式 : 開始協作
        協作模式 --> 編輯模式 : 結束協作
        編輯模式 --> 轉調模式 : 執行轉調
        轉調模式 --> 編輯模式
        編輯模式 --> 匯出模式 : 匯出樂譜
        匯出模式 --> 編輯模式
        編輯模式 --> 儲存中 : 自動儲存
        儲存中 --> 編輯模式
    }
    
    樂譜編輯 --> 樂譜列表 : 關閉編輯器
```

---

## 6. 部署架構圖

### 6.1 系統部署圖
```mermaid
graph TB
    subgraph "用戶端"
        B1[Chrome 瀏覽器]
        B2[Firefox 瀏覽器]
        B3[Safari 瀏覽器]
        M1[移動端 Chrome]
        M2[移動端 Safari]
    end
    
    subgraph "CDN 層"
        CDN[內容分發網路<br/>靜態資源快取]
    end
    
    subgraph "負載均衡層"
        LB[Nginx<br/>負載均衡器]
    end
    
    subgraph "應用伺服器層"
        AS1[Node.js 伺服器 1<br/>API + WebSocket]
        AS2[Node.js 伺服器 2<br/>API + WebSocket]
        AS3[Node.js 伺服器 3<br/>API + WebSocket]
    end
    
    subgraph "快取層"
        RC1[Redis 叢集<br/>會話快取]
        RC2[Redis 叢集<br/>協作狀態]
    end
    
    subgraph "資料庫層"
        DB1[(MongoDB 主節點<br/>樂譜資料)]
        DB2[(MongoDB 從節點 1)]
        DB3[(MongoDB 從節點 2)]
    end
    
    subgraph "檔案儲存"
        FS[雲端檔案儲存<br/>匯出檔案]
    end
    
    B1 --> CDN
    B2 --> CDN
    B3 --> CDN
    M1 --> CDN
    M2 --> CDN
    
    CDN --> LB
    LB --> AS1
    LB --> AS2
    LB --> AS3
    
    AS1 --> RC1
    AS2 --> RC1
    AS3 --> RC1
    AS1 --> RC2
    AS2 --> RC2
    AS3 --> RC2
    
    AS1 --> DB1
    AS2 --> DB1
    AS3 --> DB1
    DB1 --> DB2
    DB1 --> DB3
    
    AS1 --> FS
    AS2 --> FS
    AS3 --> FS
```

---

## 7. 安全架構圖

### 7.1 安全防護層次圖
```mermaid
graph TD
    subgraph "網路安全層"
        FW[防火牆]
        WAF[Web 應用防火牆]
        DDoS[DDoS 防護]
    end
    
    subgraph "傳輸安全層"
        TLS[TLS/SSL 加密]
        HSTS[HTTP 嚴格傳輸安全]
    end
    
    subgraph "應用安全層"
        AUTH[JWT 身份驗證]
        AUTHZ[權限控制]
        CSRF[CSRF 防護]
        XSS[XSS 防護]
    end
    
    subgraph "資料安全層"
        ENCRYPT[資料庫加密]
        BACKUP[資料備份]
        AUDIT[審計日誌]
    end
    
    Internet --> FW
    FW --> WAF
    WAF --> DDoS
    DDoS --> TLS
    TLS --> HSTS
    HSTS --> AUTH
    AUTH --> AUTHZ
    AUTHZ --> CSRF
    CSRF --> XSS
    XSS --> ENCRYPT
    ENCRYPT --> BACKUP
    BACKUP --> AUDIT
```

此文件提供了 BandPro 系統的全面視覺化架構說明，涵蓋系統設計的各個層面，有助於開發團隊理解系統整體結構和各組件間的關係。
